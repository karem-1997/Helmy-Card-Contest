<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helmy Card V2 - Premium Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <style>
        :root { --red: #ff0000; --dark-red: #8b0000; --bg: #000000; --card: #0a0a0a; --gold: #ff9800; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        
        /* Ø§Ù„Ø§Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙØ®Ù… */
        .card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--dark-red); box-shadow: 0 0 15px rgba(255, 0, 0, 0.2); }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #333; background: #111; color: white; font-size: 15px; }
        input:focus { border-color: var(--red); outline: none; box-shadow: 0 0 5px var(--red); }
        
        .btn-main { background: linear-gradient(45deg, var(--dark-red), var(--red)); color: white; font-weight: bold; cursor: pointer; border: none; padding: 12px; border-radius: 8px; width: 100%; margin-top: 10px; }
        .btn-main:hover { opacity: 0.9; transform: scale(0.98); }
        .btn-sub { background: #222; color: #ccc; cursor: pointer; border: none; padding: 8px; border-radius: 5px; font-size: 12px; margin-top: 5px; }
        
        .hidden { display: none; }
        .stats { display: flex; justify-content: space-between; text-align: center; margin: 15px 0; }
        .stats h3 { color: var(--gold); margin: 5px 0; }
        
        .tree-item { background: #111; padding: 10px; margin: 5px 0; border-radius: 8px; border-right: 4px solid var(--red); font-size: 13px; }
        
        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; }
        th, td { border: 1px solid #222; padding: 10px; text-align: center; }
        th { background: var(--dark-red); color: white; }
        
        .floating-btn { position: fixed; bottom: 20px; left: 20px; background: var(--red); color: white; padding: 12px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; border: none; z-index: 1000; box-shadow: 0 0 10px var(--red); }
        
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; display: inline-block; }
        .pending { background: #555; }
        .success { background: green; }
        
        .admin-actions button { margin: 2px; padding: 5px; font-size: 10px; cursor: pointer; border-radius: 3px; border: none; }
        .del-btn { background: #ff4444; color: white; }
        .edit-btn { background: #ff9800; color: black; }
    </style>
</head>
<body>

<button class="floating-btn" onclick="toggleModal(true)">ğŸ“œ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯</button>

<div id="termsModal" class="hidden" style="position:fixed; z-index:2001; background:rgba(0,0,0,0.9); width:100%; height:100%; top:0; left:0; display: flex; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 80%;">
        <h2 style="color:var(--red); text-align:center">ğŸ† Ø´Ø±ÙˆØ· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h2>
        <p>1. Ø´Ø­Ù† 1000Ø¬ ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰.<br>2. Ø¨ÙˆÙ†Øµ 5% Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø­Ù†.<br>3. Ø¨ÙˆÙ†Øµ 10% Ù…Ù† Ø´Ø­Ù† ÙØ±ÙŠÙ‚Ùƒ.<br>4. ØªÙØ¹ÙŠÙ„ Ø­Ù„Ù…ÙŠ ÙŠØ¯ÙˆÙŠ.</p>
        <button class="btn-main" onclick="toggleModal(false)">ÙÙ‡Ù…Øª</button>
    </div>
</div>

<div class="container">
    <h1 style="text-align: center; color: var(--red); text-shadow: 0 0 10px var(--red);">ğŸ¦… HELMY CARD V2</h1>

    <div id="auth-section" class="card">
        <div style="display:flex; gap:10px; margin-bottom:15px">
            <button id="tabL" class="btn-main" onclick="switchTab('login')">Ø¯Ø®ÙˆÙ„</button>
            <button id="tabR" class="btn-sub" onclick="switchTab('register')">ØªØ³Ø¬ÙŠÙ„</button>
        </div>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <div id="reg-fields" class="hidden">
            <input type="text" id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="text" id="customCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ">
            <input type="text" id="wallet" placeholder="Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© Ø§Ù„ÙƒØ§Ø´">
            <input type="text" id="invBy" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø§Ø¹ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        </div>
        <button class="btn-main" id="mainBtn" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ù†</button>
    </div>

    <div id="user-section" class="hidden">
        <div class="card" style="border-color: var(--gold);">
            <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹: <span id="uName" style="color:var(--red)">...</span></h3>
            <div class="stats">
                <div><h3 id="uBalance">0</h3><p>Ø±ØµÙŠØ¯Ùƒ</p></div>
                <div><h3 id="uTeam">0</h3><p>ÙØ±ÙŠÙ‚Ùƒ</p></div>
            </div>
            <p style="text-align:center; font-size:12px; background:#111; padding:8px; border-radius:5px">ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØªÙƒ: <b id="uCode" style="color:var(--gold)"></b></p>
        </div>

        <div class="card" style="border-color: var(--red);">
            <h3>ğŸ’° Ø¥Ø´Ø¹Ø§Ø± Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯</h3>
            <input type="number" id="depAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø´Ø­ÙˆÙ†">
            <button class="btn-main" onclick="sendRequest()">Ø¥Ø¨Ù„Ø§Øº Ø­Ù„Ù…ÙŠ Ø¨Ø§Ù„Ø´Ø­Ù† âœ‰ï¸</button>
            <div id="reqStatus" style="text-align:center; margin-top:10px"></div>
        </div>

        <div class="card">
            <h3>ğŸŒ³ Ø§Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</h3>
            <div id="treeList"></div>
        </div>
        <button class="btn-sub" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="admin-section" class="hidden">
        <div class="card" style="border-color: #00ff00;">
            <h2 style="color:#00ff00; text-align:center">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙŠØ§ ğŸ‘‘</h2>
            <p style="font-size:12px">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:</p>
            <table id="reqTable">
                <thead><tr><th>Ø§Ù„ÙˆÙƒÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº+5%</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="adminReqList"></tbody>
            </table>
        </div>

        <div class="card">
            <h2 style="color:var(--gold); text-align:center">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</h2>
            <table id="usersTable">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="adminUserList"></tbody>
            </table>
        </div>
        <button class="btn-sub" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBAIB47-TaUEZDZHlXgAsI4RUckzn8C3Io",
        authDomain: "helmy-card-contest.firebaseapp.com",
        projectId: "helmy-card-contest",
        storageBucket: "helmy-card-contest.firebasestorage.app",
        messagingSenderId: "765996977390",
        appId: "1:765996977390:web:b5ce6c4980e6bbfa40b7ff"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const ADMIN_EMAIL = "admin@helmy.com";

    function toggleModal(s) { document.getElementById('termsModal').classList.toggle('hidden', !s); }
    function switchTab(m) {
        const isR = m === 'register';
        document.getElementById('reg-fields').classList.toggle('hidden', !isR);
        document.getElementById('mainBtn').innerText = isR ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯' : 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ù†';
        window.mode = m;
    }

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        if(window.mode !== 'register') {
            auth.signInWithEmailAndPassword(email, pass).catch(e => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"));
        } else {
            const name = document.getElementById('fullName').value;
            const myCode = document.getElementById('customCode').value;
            const wallet = document.getElementById('wallet').value;
            const invBy = document.getElementById('invBy').value;
            try {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection("users").doc(res.user.uid).set({
                    name, myCode, wallet, email, balance: 0, invitedBy: invBy || "direct", uid: res.user.uid
                });
            } catch(e) { alert(e.message); }
        }
    }

    auth.onAuthStateChanged(user => {
        if(user) {
            document.getElementById('auth-section').classList.add('hidden');
            if(user.email === ADMIN_EMAIL) {
                document.getElementById('admin-section').classList.remove('hidden');
                loadAdminAll();
            } else {
                document.getElementById('user-section').classList.remove('hidden');
                loadUserData(user);
            }
        }
    });

    function loadUserData(user) {
        db.collection("users").doc(user.uid).onSnapshot(d => {
            const data = d.data();
            if(data) {
                document.getElementById('uName').innerText = data.name;
                document.getElementById('uBalance').innerText = data.balance + " Ø¬";
                document.getElementById('uCode').innerText = data.myCode;
                db.collection("users").where("invitedBy", "==", data.myCode).onSnapshot(team => {
                    document.getElementById('uTeam').innerText = team.size;
                    const tree = document.getElementById('treeList');
                    tree.innerHTML = team.empty ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙƒÙ„Ø§Ø¡" : "";
                    team.forEach(m => tree.innerHTML += `<div class="tree-item">ğŸ‘¤ ${m.data().name}</div>`);
                });
            }
        });
        db.collection("requests").where("uid", "==", user.uid).orderBy("createdAt", "desc").limit(1).onSnapshot(s => {
            const stat = document.getElementById('reqStatus');
            if(!s.empty) {
                const r = s.docs[0].data();
                stat.innerHTML = r.status === "ØªÙ…" ? `<span class="status-badge success">ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ âœ…</span>` : `<span class="status-badge pending">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø­Ù„Ù…ÙŠ.. â³</span>`;
            }
        });
    }

    async function sendRequest() {
        const amt = Number(document.getElementById('depAmt').value);
        if(amt < 1000) return alert("Ø£Ù‚Ù„ Ø´Ø­Ù† 1000Ø¬");
        const userD = await db.collection("users").doc(auth.currentUser.uid).get();
        await db.collection("requests").add({ uid: auth.currentUser.uid, name: userD.data().name, amount: amt, status: "Ù…Ø¹Ù„Ù‚", createdAt: new Date() });
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±!");
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø­Ù„Ù…ÙŠ (Ø§Ù„Ø£Ø¯Ù…Ù†)
    function loadAdminAll() {
        // Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†
        db.collection("requests").where("status", "==", "Ù…Ø¹Ù„Ù‚").onSnapshot(s => {
            const list = document.getElementById('adminReqList');
            list.innerHTML = "";
            s.forEach(doc => {
                const d = doc.data();
                const total = d.amount + (d.amount * 0.05);
                list.innerHTML += `<tr><td>${d.name}</td><td>${total}Ø¬</td><td><button class="btn-main" style="padding:5px" onclick="approveReq('${doc.id}', '${d.uid}', ${total})">ØªØ£ÙƒÙŠØ¯</button></td></tr>`;
            });
        });

        // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
        db.collection("users").onSnapshot(s => {
            const list = document.getElementById('adminUserList');
            list.innerHTML = "";
            s.forEach(doc => {
                const u = doc.data();
                if(u.email !== ADMIN_EMAIL) {
                    list.innerHTML += `<tr>
                        <td>${u.name}</td>
                        <td>${u.balance}Ø¬</td>
                        <td class="admin-actions">
                            <button class="edit-btn" onclick="editBalance('${doc.id}', ${u.balance})">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="del-btn" onclick="deleteUser('${doc.id}')">Ø­Ø°Ù</button>
                        </td>
                    </tr>`;
                }
            });
        });
    }

    async function approveReq(id, uid, total) {
        await db.collection("users").doc(uid).update({ balance: firebase.firestore.FieldValue.increment(total) });
        await db.collection("requests").doc(id).update({ status: "ØªÙ…" });
    }

    async function editBalance(id, current) {
        const newVal = prompt("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", current);
        if(newVal !== null) await db.collection("users").doc(id).update({ balance: Number(newVal) });
    }

    async function deleteUser(id) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) await db.collection("users").doc(id).delete();
    }

    function logout() { auth.signOut(); location.reload(); }
</script>
</body>
</html>
