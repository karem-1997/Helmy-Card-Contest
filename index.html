<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helmy Card - V6 Control Panel</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <style>
        :root { --red: #ff0000; --gold: #ff9800; --green: #00ff00; --bg: #000; --card: #0a0a0a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; text-align: right; }
        .container { max-width: 900px; margin: auto; }
        .card { background: var(--card); border: 1px solid #222; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-right: 5px solid var(--red); }
        .search-box { background: #111; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--gold); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        th, td { border: 1px solid #222; padding: 10px; text-align: center; }
        th { background: #1a1a1a; color: var(--gold); }
        .btn-main { background: var(--red); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-sub { background: #222; color: #ccc; border: none; padding: 8px; border-radius: 5px; width: 100%; cursor: pointer; margin-top: 5px; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; background: #000; border: 1px solid #333; color: white; border-radius: 5px; box-sizing: border-box; }
        .id-badge { font-family: monospace; background: #222; color: var(--gold); padding: 3px 6px; border-radius: 4px; font-size: 10px; }
        .agent-detail-card { background: #050505; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-top: 10px; display: none; }
        .hidden { display: none !important; }
        .active-row { background: rgba(255, 152, 0, 0.05); cursor: pointer; }
        .active-row:hover { background: rgba(255, 152, 0, 0.1); }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color:var(--red);">ğŸ¦… Ù„ÙˆØ­Ø© Ø±Ù‚Ø§Ø¨Ø© Ø­Ù„Ù…ÙŠ - HELMY CARD</h1>

    <div id="auth-box" class="card hidden">
        <input type="email" id="email" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø£Ø¯Ù…Ù†">
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn-main" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ Ø­Ù„Ù…ÙŠ</button>
    </div>

    <div id="admin-box" class="hidden">
        
        <div class="card" style="border-right-color: var(--green);">
            <h2 style="color:var(--green)">â³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <table id="req-table">
                <thead>
                    <tr><th>Ø§Ù„ÙˆÙƒÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¨ÙˆÙ†Øµ (+5%)</th><th>ØªØ£ÙƒÙŠØ¯</th></tr>
                </thead>
                <tbody id="adm-requests"></tbody>
            </table>
        </div>

        <div class="search-box">
            <h3 style="color:var(--gold); margin-top:0;">ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆÙƒÙŠÙ„ (Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…)</h3>
            <input type="text" id="adminSearch" onkeyup="filterAgents()" placeholder="Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„ (Ù…Ø«Ù„Ø§Ù‹: 2020) Ø£Ùˆ Ø§Ø³Ù…Ù‡...">
        </div>

        <div class="card">
            <h3>ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ (Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙŠÙ‚)</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>ID</th>
                            <th>ÙƒÙˆØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„</th>
                            <th>Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙˆÙ†Øµ</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody id="adm-users-list"></tbody>
                </table>
            </div>
        </div>

        <div id="agent-profile" class="card hidden" style="border-right-color: var(--gold);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="color:var(--gold)">ğŸ“‚ Ù…Ù„Ù Ø§Ù„ÙˆÙƒÙŠÙ„: <span id="prof-name"></span></h2>
                <button onclick="closeProfile()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <div id="prof-stats" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                </div>
            <h3>ğŸŒ³ ÙØ±ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆØ£Ø±Ø¨Ø§Ø­Ù‡ Ù…Ù†Ù‡Ù…:</h3>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ</th>
                        <th>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø¶Ùˆ</th>
                        <th>Ø´Ø­Ù† Ø§Ù„Ø¹Ø¶Ùˆ</th>
                        <th>Ø¨ÙˆÙ†Øµ Ù„Ù„ÙˆÙƒÙŠÙ„ (5%)</th>
                    </tr>
                </thead>
                <tbody id="prof-team-list"></tbody>
            </table>
        </div>

        <button class="btn-sub" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
    // Firebase Config (Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
    const firebaseConfig = {
        apiKey: "AIzaSyBAIB47-TaUEZDZHlXgAsI4RUckzn8C3Io",
        authDomain: "helmy-card-contest.firebaseapp.com",
        projectId: "helmy-card-contest",
        storageBucket: "helmy-card-contest.firebasestorage.app",
        messagingSenderId: "765996977390",
        appId: "1:765996977390:web:b5ce6c4980e6bbfa40b7ff"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const ADMIN = "admin@helmy.com";

    // Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function handleAuth() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        auth.signInWithEmailAndPassword(e, p).catch(err => alert("Ø®Ø·Ø£"));
    }

    auth.onAuthStateChanged(user => {
        if(user && user.email === ADMIN) {
            document.getElementById('auth-box').classList.add('hidden');
            document.getElementById('admin-box').classList.remove('hidden');
            loadAdminData();
        } else {
            document.getElementById('auth-box').classList.remove('hidden');
        }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    function loadAdminData() {
        // Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†
        db.collection("requests").where("status", "==", "pending").onSnapshot(s => {
            const list = document.getElementById('adm-requests'); list.innerHTML = "";
            s.forEach(doc => {
                const r = doc.data();
                list.innerHTML += `<tr><td>${r.name}</td><td>${r.amount}Ø¬</td><td style="color:var(--gold)">+${r.bonus}Ø¬</td><td><button onclick="approve('${doc.id}', '${r.uid}', ${r.amount}, ${r.bonus}, '${r.invBy}')" class="btn-main" style="padding:5px;">ØªØ£ÙƒÙŠØ¯</button></td></tr>`;
            });
        });

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡
        db.collection("users").onSnapshot(s => {
            const list = document.getElementById('adm-users-list'); list.innerHTML = "";
            s.forEach(doc => {
                const u = doc.data();
                if(u.email !== ADMIN) {
                    list.innerHTML += `
                        <tr class="active-row" onclick="showAgentProfile('${u.uid}', '${u.name}', '${u.myCode}', ${u.balance}, ${u.bonusBalance})">
                            <td style="font-weight:bold; color:var(--gold)">${u.name}</td>
                            <td><span class="id-badge">#${u.uid.substring(0,6)}</span></td>
                            <td>${u.myCode}</td>
                            <td>${u.balance || 0}Ø¬</td>
                            <td>${u.bonusBalance || 0}Ø¬</td>
                            <td>${u.userType}</td>
                            <td><button onclick="event.stopPropagation(); delUser('${doc.id}')" style="background:red; border:none; color:white; border-radius:3px;">X</button></td>
                        </tr>`;
                }
            });
        });
    }

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø«
    function filterAgents() {
        let input = document.getElementById('adminSearch').value.toLowerCase();
        let rows = document.getElementById('adm-users-list').getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
        }
    }

    // Ø¹Ø±Ø¶ Ù…Ù„Ù Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆÙØ±ÙŠÙ‚Ù‡ Ø¨Ø§Ù„ØªÙØµÙŠÙ„
    async function showAgentProfile(uid, name, code, bal, bonus) {
        const prof = document.getElementById('agent-profile');
        prof.classList.remove('hidden');
        document.getElementById('prof-name').innerText = name;
        
        const stats = document.getElementById('prof-stats');
        stats.innerHTML = `
            <div class="stat-box" style="background:#111; padding:10px; border-radius:5px; border:1px solid #333;">Ø±ØµÙŠØ¯Ù‡ Ø§Ù„Ø´Ø®ØµÙŠ: ${bal}Ø¬</div>
            <div class="stat-box" style="background:#111; padding:10px; border-radius:5px; border:1px solid #333;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨ÙˆÙ†ØµÙ‡: ${bonus}Ø¬</div>
        `;

        // Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙŠÙ‚
        const teamList = document.getElementById('prof-team-list');
        teamList.innerHTML = "<tr><td colspan='4'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙŠÙ‚...</td></tr>";
        
        const teamSnap = await db.collection("users").where("invitedBy", "==", code).get();
        teamList.innerHTML = "";
        
        if(teamSnap.empty) {
            teamList.innerHTML = "<tr><td colspan='4'>Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ ÙØ±ÙŠÙ‚ Ø¨Ø¹Ø¯.</td></tr>";
        } else {
            teamSnap.forEach(async (memberDoc) => {
                const member = memberDoc.data();
                // Ø¬Ù„Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø­Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ
                const chargeSnap = await db.collection("requests").where("uid", "==", member.uid).where("status", "==", "done").get();
                let totalMemberCharge = 0;
                chargeSnap.forEach(c => totalMemberCharge += c.data().amount);
                
                teamList.innerHTML += `
                    <tr>
                        <td>${member.name}</td>
                        <td>${member.myCode}</td>
                        <td style="color:var(--green)">${totalMemberCharge}Ø¬</td>
                        <td style="color:var(--gold)">${(totalMemberCharge * 0.05).toFixed(1)}Ø¬</td>
                    </tr>
                `;
            });
        }
        // Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø£Ø³ÙÙ„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù„Ù
        prof.scrollIntoView({ behavior: 'smooth' });
    }

    function closeProfile() { document.getElementById('agent-profile').classList.add('hidden'); }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ V5)
    async function approve(rid, uid, amt, bonus, invBy) {
        await db.collection("users").doc(uid).update({ 
            balance: firebase.firestore.FieldValue.increment(amt), 
            bonusBalance: firebase.firestore.FieldValue.increment(bonus), 
            isFirst: false 
        });
        if(invBy && invBy !== "direct") {
            const invRef = await db.collection("users").where("myCode", "==", invBy).get();
            if(!invRef.empty) {
                await db.collection("users").doc(invRef.docs[0].id).update({ 
                    bonusBalance: firebase.firestore.FieldValue.increment(amt * 0.05) 
                });
            }
        }
        await db.collection("requests").doc(rid).update({ status: 'done' });
    }

    async function delUser(id) { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) await db.collection("users").doc(id).delete(); }
    function logout() { auth.signOut(); location.reload(); }
</script>
</body>
</html>
